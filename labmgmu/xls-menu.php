<?phpset_time_limit (300);function add_load_xls_options(){    add_options_page(        'Экспорт в Excel',        'Экспорт в Excel',        'manage_options',        'xls_functions',        'export_xls_options'    );    add_options_page(        'Импорт из Excel',        'Импорт из Excel',        'manage_options',        'xls_import_functions',        'import_xls_options'    );}function export_xls_options(){    ?>    <div class="wrap">        <h2>Экспорт в Excel</h2>        <form enctype="multipart/form-data" method="post" target="_blank"              action="<?php echo get_template_directory_uri(); ?>/xls-news.php">            <p><input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="NewsExport"                      value="Экспортировать новости"/></p>        </form>        <form enctype="multipart/form-data" method="post" target="_blank"              action="<?php echo get_template_directory_uri(); ?>/xls-preg.php">            <p><input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="RegExport"                      value="Экспортировать регламент (Доклинические исследования)"/></p>        </form>        <form enctype="multipart/form-data" method="post" target="_blank"              action="<?php echo get_template_directory_uri(); ?>/xls-creg.php">            <p><input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="СRegExport"                      value="Экспортировать регламент (Клинические исследования)"/></p>        </form>        <form enctype="multipart/form-data" method="post" target="_blank"              action="<?php echo get_template_directory_uri(); ?>/xls-volunteers.php">            <p><input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="СVExport"                      value="Экспортировать список добровольцев"/></p>        </form>    </div><?php}function import_xls_options(){    if (isset($_POST['NewsImport'])) {        echo '<hr>';        if (isset($_POST['newsDelete'])) {            $news = get_posts(                array(                    'numberposts' => -1,                    'offset' => 0,                    'category' => '',                    'include' => '',                    'exclude' => '',                    'meta_key' => '',                    'meta_value' => '',                    'post_type' => 'news',                    'post_parent' => '',                    'post_status' => 'publish'                )            );            $delete_count = 0;            foreach ($news as $obj) {                if ($obj->post_title != 'Архив новостей') {                    wp_delete_post($obj->ID, true);                    $delete_count++;                }            }            echo 'Удалено: <b>' . $delete_count . ' новостей.</b><hr>';        }        if (isset($_FILES['news_xls_file']['tmp_name']) && !empty($_FILES['news_xls_file']['tmp_name'])) {            include 'Classes/PHPExcel/IOFactory.php';            $inputFileName = $_FILES['news_xls_file']['tmp_name'];            $objPHPExcel = PHPExcel_IOFactory::load($inputFileName);            $objPHPExcel->setActiveSheetIndex(0);            $sheetData1 = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);            $import_count = 0;            foreach ($sheetData1 as $index => $row) {                if ($index < 2 || $row['B'] == 'Архив новостей') {                    continue;                }                $post_date = $row['A'];                $post_title = $row['B'];                $post_description = $row['C'];                $post_content = $row['D'];                $post_picture = $row['E'];                $post_author = $row['F'];                $post_data = array(                    'ID' => 0,                    'post_title' => wp_strip_all_tags($post_title),                    'post_status' => 'publish',                    'post_author' => 1,                    'post_date' => $post_date,                    'post_type' => 'news',                );                $ID = wp_insert_post($post_data);                $post_data['ID'] = $ID;                update_post_meta($ID, 'description', $post_description);                update_post_meta($ID, 'author', $post_author);                update_post_meta($ID, 'content', $post_content);                if (!empty($post_picture)) {                    $img = array(                        'url' => $post_picture                    );                }                update_post_meta($ID, 'picture', $img);                update_post_meta($ID, 'big_picture', $img);                if (isset($_POST['newsDelete'])) {                    if (!$import_count) {                        update_post_meta($ID, 'main', true);                    }                }                //var_dump($row['B']);                $import_count++;            }            echo 'Добавлено: <b>' . $import_count . ' новостей.</b>';        } else {            echo "Не выбран файл.";        }        echo '<hr>';    }    if (isset($_POST['PRegImport'])) {        echo '<hr>';        if (isset($_POST['pregDelete'])) {            $news = get_posts(                array(                    'numberposts' => -1,                    'offset' => 0,                    'category' => '',                    'include' => '',                    'exclude' => '',                    'meta_key' => '',                    'meta_value' => '',                    'post_type' => 'prrs_order',                    'post_parent' => '',                    'post_status' => 'publish'                )            );            $delete_count = 0;            foreach ($news as $obj) {                wp_delete_post($obj->ID, true);                $delete_count++;            }            echo 'Удалено: <b>' . $delete_count . ' записей.</b><hr>';        }        if (isset($_FILES['preg_xls_file']['tmp_name']) && !empty($_FILES['preg_xls_file']['tmp_name'])) {            include 'Classes/PHPExcel/IOFactory.php';            $inputFileName = $_FILES['preg_xls_file']['tmp_name'];            $objPHPExcel = PHPExcel_IOFactory::load($inputFileName);            $objPHPExcel->setActiveSheetIndex(0);            $sheetData1 = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);            $list = array();            foreach ($sheetData1 as $index => $row) {                if ($index < 2) {                    continue;                }                $list[] = array(                    'ID' => $row['A'],                    'post_title' => $row['B'],                    'post_content' => $row['C'],                    'menu_order' => $row['D'],                    'post_parent' => $row['E']                );            }            usort($list, 'cmp_parent');            $tmp_list = array();            $import_count = 0;            while (count($list)) {                $obj = array_shift($list);                $new_ID = -1;                if ($obj['post_parent']) {                    foreach ($tmp_list as $new) {                        if ($new['ID'] == $obj['post_parent']) {                            if ($new['new_ID']) {                                $new_ID = $new['new_ID'];                            }                            break;                        }                    }                    if ($new_ID < 0) {                        $new_ID = -2;                        foreach ($list as $new) {                            if ($new['ID'] == $obj['post_parent']) {                                $new_ID = -1;                                break;                            }                        }                    }                } else {                    $new_ID = 0;                }                if ($new_ID < 0) {                    if ($new_ID == -1) {                        $list[] = $obj;                    }                } else {                    $post_data = array(                        'ID' => 0,                        'post_title' => wp_strip_all_tags($obj['post_title']),                        'post_status' => 'publish',                        'post_parent' => $new_ID,                        'post_author' => 1,                        'menu_order' => $obj['menu_order'],                        'post_type' => 'prrs_order',                    );                    $import_count++;                    $ID = wp_insert_post($post_data);                    $post_data['ID'] = $ID;                    update_post_meta($ID, 'description', $obj['post_content']);                    $obj['new_ID'] = $ID;                    $tmp_list[] = $obj;                }            }            echo 'Добавлено: <b>' . $import_count . ' записей.</b>';        } else {            echo "Не выбран файл.";        }        echo '<hr>';    }    if (isset($_POST['CRegImport'])) {        echo '<hr>';        if (isset($_POST['cregDelete'])) {            $news = get_posts(                array(                    'numberposts' => -1,                    'offset' => 0,                    'category' => '',                    'include' => '',                    'exclude' => '',                    'meta_key' => '',                    'meta_value' => '',                    'post_type' => 'clrs_order',                    'post_parent' => '',                    'post_status' => 'publish'                )            );            $delete_count = 0;            foreach ($news as $obj) {                wp_delete_post($obj->ID, true);                $delete_count++;            }            echo 'Удалено: <b>' . $delete_count . ' записей.</b><hr>';        }        if (isset($_FILES['creg_xls_file']['tmp_name']) && !empty($_FILES['creg_xls_file']['tmp_name'])) {            include 'Classes/PHPExcel/IOFactory.php';            $inputFileName = $_FILES['creg_xls_file']['tmp_name'];            $objPHPExcel = PHPExcel_IOFactory::load($inputFileName);            $objPHPExcel->setActiveSheetIndex(0);            $sheetData1 = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);            $list = array();            foreach ($sheetData1 as $index => $row) {                if ($index < 2) {                    continue;                }                $list[] = array(                    'ID' => $row['A'],                    'post_title' => $row['B'],                    'post_content' => $row['C'],                    'menu_order' => $row['D'],                    'post_parent' => $row['E']                );            }            usort($list, 'cmp_parent');            $tmp_list = array();            $import_count = 0;            while (count($list)) {                $obj = array_shift($list);                $new_ID = -1;                if ($obj['post_parent']) {                    foreach ($tmp_list as $new) {                        if ($new['ID'] == $obj['post_parent']) {                            if ($new['new_ID']) {                                $new_ID = $new['new_ID'];                            }                            break;                        }                    }                    if ($new_ID < 0) {                        $new_ID = -2;                        foreach ($list as $new) {                            if ($new['ID'] == $obj['post_parent']) {                                $new_ID = -1;                                break;                            }                        }                    }                } else {                    $new_ID = 0;                }                if ($new_ID < 0) {                    if ($new_ID == -1) {                        $list[] = $obj;                    }                } else {                    $post_data = array(                        'ID' => 0,                        'post_title' => wp_strip_all_tags($obj['post_title']),                        'post_status' => 'publish',                        'post_parent' => $new_ID,                        'post_author' => 1,                        'menu_order' => $obj['menu_order'],                        'post_type' => 'clrs_order',                    );                    $import_count++;                    $ID = wp_insert_post($post_data);                    $post_data['ID'] = $ID;                    update_post_meta($ID, 'description', $obj['post_content']);                    $obj['new_ID'] = $ID;                    $tmp_list[] = $obj;                }            }            echo 'Добавлено: <b>' . $import_count . ' записей.</b>';        } else {            echo "Не выбран файл.";        }        echo '<hr>';    }    if (isset($_POST['wikiImport'])) {        echo '<hr>';        if (isset($_POST['wikiDelete'])) {            $news = get_posts(                array(                    'numberposts' => -1,                    'offset' => 0,                    'category' => '',                    'include' => '',                    'exclude' => '',                    'meta_key' => '',                    'meta_value' => '',                    'post_type' => 'wiki',                    'post_parent' => '',                    'post_status' => 'publish'                )            );            $delete_count = 0;            foreach ($news as $obj) {                wp_delete_post($obj->ID, true);                $delete_count++;            }            echo 'Удалено: <b>' . $delete_count . ' терминов.</b><hr>';        }        if (isset($_FILES['wiki_xls_file']['tmp_name']) && !empty($_FILES['wiki_xls_file']['tmp_name'])) {            include 'Classes/PHPExcel/IOFactory.php';            $inputFileName = $_FILES['wiki_xls_file']['tmp_name'];            $objPHPExcel = PHPExcel_IOFactory::load($inputFileName);            $objPHPExcel->setActiveSheetIndex(0);            $sheetData1 = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);            $import_count = 0;            foreach ($sheetData1 as $index => $row) {                $post_title = array();                $post_description = $row['B'];                if (mb_strpos($row['A'], '(')) {                    $post_title[] = mb_substr($row['A'], 0, mb_strpos($row['A'], '(') - 1);                    $post_title[] = mb_substr(                        $row['A'],                        mb_strpos($row['A'], '(') + 1,                        mb_strpos($row['A'], ')') - mb_strpos($row['A'], '(') - 1                    );                } else {                    $post_title = array($row['A']);                }                foreach ($post_title as $obj) {                    $post_data = array(                        'ID' => 0,                        'post_title' => wp_strip_all_tags($obj),                        'post_status' => 'publish',                        'post_author' => 1,                        'post_type' => 'wiki',                    );                    $ID = wp_insert_post($post_data);                    update_post_meta($ID, 'description', $post_description);                    $import_count++;                }            }            echo 'Добавлено: <b>' . $import_count . ' терминов.</b>';        } else {            echo "Не выбран файл.";        }        echo '<hr>';    }    if (isset($_POST['drugsImport'])) {        echo '<hr>';        if (isset($_POST['drugsDelete'])) {            $news = get_posts(                array(                    'numberposts' => -1,                    'offset' => 0,                    'category' => '',                    'include' => '',                    'exclude' => '',                    'meta_key' => '',                    'meta_value' => '',                    'post_type' => 'drugs',                    'post_parent' => '',                    'post_status' => 'publish'                )            );            $delete_count = 0;            foreach ($news as $obj) {                wp_delete_post($obj->ID, true);                $delete_count++;            }            echo 'Удалено: <b>' . $delete_count . ' препаратов.</b><hr>';        }        if (isset($_FILES['drugs_xls_file']['tmp_name']) && !empty($_FILES['drugs_xls_file']['tmp_name'])) {            include 'Classes/PHPExcel/IOFactory.php';            $inputFileName = $_FILES['drugs_xls_file']['tmp_name'];            $objPHPExcel = PHPExcel_IOFactory::load($inputFileName);            $objPHPExcel->setActiveSheetIndex(0);            $sheetData1 = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);            $import_count = 0;            for ( $i = count($sheetData1); $i > 0; $i-- ) {                $row = $sheetData1[$i];                $post_title = $row['A'];                $post_title_en = $row['B'];                $post_data = array(                    'ID' => 0,                    'post_title' => wp_strip_all_tags($post_title),                    'post_status' => 'publish',                    'post_author' => 1,                    'post_type' => 'drugs',                );                $ID = wp_insert_post($post_data);                update_post_meta($ID, 'title_en', $post_title_en);                $import_count++;            }            echo 'Добавлено: <b>' . $import_count . ' препаратов.</b>';        } else {            echo "Не выбран файл.";        }        echo '<hr>';    }    if (isset($_POST['mhhImport'])) {        echo '<hr>';        if (isset($_POST['mhhDelete'])) {            $news = get_posts(                array(                    'numberposts' => -1,                    'offset' => 0,                    'category' => '',                    'include' => '',                    'exclude' => '',                    'meta_key' => '',                    'meta_value' => '',                    'post_type' => 'mhh',                    'post_parent' => '',                    'post_status' => 'publish'                )            );            $delete_count = 0;            foreach ($news as $obj) {                wp_delete_post($obj->ID, true);                $delete_count++;            }            echo 'Удалено: <b>' . $delete_count . ' МНН.</b><hr>';        }        if (isset($_FILES['mhh_xls_file']['tmp_name']) && !empty($_FILES['mhh_xls_file']['tmp_name'])) {            include 'Classes/PHPExcel/IOFactory.php';            $inputFileName = $_FILES['mhh_xls_file']['tmp_name'];            $objPHPExcel = PHPExcel_IOFactory::load($inputFileName);            $objPHPExcel->setActiveSheetIndex(0);            $sheetData1 = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);            $import_count = 0;            for ( $i = count($sheetData1); $i > 0; $i-- ) {                $row = $sheetData1[$i];                $post_title = $row['A'];                $post_mhh = $row['B'];                $post_title_en = $row['C'];                $post_mhh_en = $row['D'];                $post_data = array(                    'ID' => 0,                    'post_title' => wp_strip_all_tags($post_title),                    'post_status' => 'publish',                    'post_author' => 1,                    'post_type' => 'mhh',                );                $ID = wp_insert_post($post_data);                update_post_meta($ID, 'title_en', $post_title_en);                update_post_meta($ID, 'mhh', $post_mhh);                update_post_meta($ID, 'mhh_en', $post_mhh_en);                $import_count++;            }            echo 'Добавлено: <b>' . $import_count . ' МНН.</b>';        } else {            echo "Не выбран файл.";        }        echo '<hr>';    }    if (isset($_POST['volunteersImport'])) {        echo '<hr>';        if (isset($_POST['volunteersDelete'])) {            $volunteers = get_posts(                array(                    'numberposts' => -1,                    'offset' => 0,                    'category' => '',                    'include' => '',                    'exclude' => '',                    'meta_key' => '',                    'meta_value' => '',                    'post_type' => 'volunteers',                    'post_parent' => '',                    'post_status' => 'publish'                )            );            $delete_count = 0;            foreach ($volunteers as $obj) {                wp_delete_post($obj->ID, true);                $delete_count++;            }            echo 'Удалено: <b>' . $delete_count . ' добровольцев.</b><hr>';        }        if (isset($_FILES['volunteers_xls_file']['tmp_name']) && !empty($_FILES['volunteers_xls_file']['tmp_name'])) {            include 'Classes/PHPExcel/IOFactory.php';            $inputFileName = $_FILES['volunteers_xls_file']['tmp_name'];            $objPHPExcel = PHPExcel_IOFactory::load($inputFileName);            $objPHPExcel->setActiveSheetIndex(0);            $sheetData1 = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);            $import_count = 0;            foreach ($sheetData1 as $index => $row) {                if ($index < 2) {                    continue;                }                $post_title = trim($row['A']);                if ($post_title == "") {                    $post_title = 'Empty';                }                $birth = trim($row['B']);                $sex = trim($row['C']);                $town = trim($row['D']);                $phone = trim($row['E']);                $email = trim($row['F']);                $study = trim($row['G']);                $reg = trim($row['H']);                $post_data = array(                    'ID' => 0,                    'post_title' => wp_strip_all_tags($post_title),                    'post_status' => 'publish',                    'post_author' => 1,                    'post_type' => 'volunteers',                    'post_date' => $reg                );                $ID = wp_insert_post($post_data);                update_post_meta($ID, 'birth', $birth);                update_post_meta($ID, 'sex', $sex);                update_post_meta($ID, 'town', $town);                update_post_meta($ID, 'phone', $phone);                update_post_meta($ID, 'email', $email);                update_post_meta($ID, 'study', $study);                $import_count++;            }            echo 'Добавлено: <b>' . $import_count . ' добровольцев.</b>';        } else {            echo "Не выбран файл.";        }        echo '<hr>';    }    ?>    <div class="wrap">        <h2>Импорт из Excel</h2>        <form enctype="multipart/form-data" method="post" action="">            <hr>            <p><strong>Укажите xls файл со списком:</strong><br/>                <input type="file" name="news_xls_file"/>            </p>            <p>                <input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="NewsImport"                       value="Импортировать новости"/>                <input id="newsDelete" name="newsDelete" type="checkbox"/><label for="newsDelete">Удалить старые                    новости</label>            </p>            <hr>        </form>        <form enctype="multipart/form-data" method="post" action="">            <hr>            <p><strong>Укажите xls файл со списком:</strong><br/>                <input type="file" name="preg_xls_file"/>            </p>            <p>                <input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="PRegImport"                       value="Импортировать регламент (Доклинические исследования)"/>                <input id="pregDelete" name="pregDelete" type="checkbox"/><label for="pregDelete">Удалить старые</label>            </p>            <hr>        </form>        <form enctype="multipart/form-data" method="post" action="">            <hr>            <p><strong>Укажите xls файл со списком:</strong><br/>                <input type="file" name="creg_xls_file"/>            </p>            <p>                <input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="CRegImport"                       value="Импортировать регламент (Клинические исследования)"/>                <input id="cregDelete" name="cregDelete" type="checkbox"/><label for="cregDelete">Удалить старые</label>            </p>            <hr>        </form>        <form enctype="multipart/form-data" method="post" action="">            <hr>            <p><strong>Укажите xls файл со списком:</strong><br/>                <input type="file" name="wiki_xls_file"/>            </p>            <p>                <input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="wikiImport"                       value="Импортировать словарь терминов"/>                <input id="wikiDelete" name="wikiDelete" type="checkbox"/><label for="wikiDelete">Удалить старые</label>            </p>            <hr>        </form>        <form enctype="multipart/form-data" method="post" action="">            <hr>            <p><strong>Укажите xls файл со списком:</strong><br/>                <input type="file" name="mhh_xls_file"/>            </p>            <p>                <input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="mhhImport"                       value="Импортировать МНН"/>                <input id="mhhDelete" name="mhhDelete" type="checkbox"/><label for="mhhDelete">Удалить старые</label>            </p>            <hr>        </form>        <form enctype="multipart/form-data" method="post" action="">            <hr>            <p><strong>Укажите xls файл со списком:</strong><br/>                <input type="file" name="drugs_xls_file"/>            </p>            <p>                <input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="drugsImport"                       value="Импортировать оригинальные лекарственные препараты"/>                <input id="drugsDelete" name="drugsDelete" type="checkbox"/><label for="drugsDelete">Удалить старые</label>            </p>            <hr>        </form>        <form enctype="multipart/form-data" method="post" action="">            <hr>            <p><strong>Укажите xls файл со списком:</strong><br/>                <input type="file" name="volunteers_xls_file"/>            </p>            <p>                <input onclick="if (!confirm('Запустить?')) { return false; }" type="submit" name="volunteersImport"                       value="Импортировать добровольцев"/>                <input id="volunteersDelete" name="volunteersDelete" type="checkbox"/><label for="volunteersDelete">Удалить старые</label>            </p>            <hr>        </form>    </div><?php}add_action('admin_menu', 'add_load_xls_options');